#	|VOP新增/VOP优化|	同步追踪|3.14.159	\events\on_action_events_1.txt		action.64/action.85/action.90/
namespace = action


# Assimilate Pops on Yearly Pulse
event = {#_|VOP优化|修改trigger/同步VOP框架批处理
	id = action.64
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		any_playable_country = {
			num_unique_species > 1
			any_owned_species = {
				has_citizenship_type = {
					type = citizenship_assimilation
					country = prev
				}
                #_|VOP|	提升优化,不要检测空物种
                count_species_pop = { count > 0 }
			}
		}
	}

	immediate = {
		log = "action.64"
	#	set_update_modifiers_batch = begin		# |VOP优化|框架已有批处理
		every_playable_country = {
			limit = {
				num_unique_species > 1
				any_owned_species = {
					has_citizenship_type = {
						type = citizenship_assimilation
						country = prev
					}
					#_|VOP新增|禁止空物种检测
					count_species_pop = { count > 0 }
				}
			}
			log = "action.64.epc"

			if = { # ascended synths
				limit = {
					NOT = { has_country_flag = synthetic_empire }
				}
				every_owned_species = {
					limit = {
						has_citizenship_type = {
							type = citizenship_assimilation
							country = prev
						}
						#_|VOP新增|禁止空物种检测
						count_species_pop = { count > 0 }
					}
					if = { # machines assimlating machines
						limit = {
							OR = {
								has_trait = trait_mechanical
								has_trait = trait_machine_unit
							}
							prev = {
								has_authority = auth_machine_intelligence
								has_active_tradition = tr_synthetics_adopt_machine
							}
						}
						# Deliberately do nothing here, see assimilation_effect
					}
					else_if = { # assimilator empire or cyborg empire
						limit = {
							prev = {
								OR = {
									AND = {
										is_hive_empire = no
										has_tradition = tr_cybernetics_transubstantiation_synthesis
									}
									AND = {
										has_authority = auth_machine_intelligence
										has_civic = civic_machine_assimilator
									}
								}
							}
						}
						modify_species = {
							species = this
							add_trait = trait_cybernetic
							add_traits_at_start_of_list = yes
							remove_trait = trait_hive_mind
							remove_trait = trait_self_modified
							remove_trait = trait_latent_psionic
							remove_trait = trait_psionic
							change_scoped_species = no

							effect = {
								set_timed_species_flag = {
									flag = assimilation_species_of_species@prev
									days = 30
								}
								set_timed_species_flag = {
									flag = assimilation_species_of_empire@prevprev
									days = 30
								}
							}
						}
					}
					else_if = { # genetic hive mind
						limit = {
							prev = {
								has_authority = auth_hive_mind
								has_tradition = tr_genetics_creation
								NOT = {
									has_civic = civic_hive_devouring_swarm
								}
							}
						}
						modify_species = {
							species = this
							add_trait = trait_hive_mind
							remove_trait = trait_self_modified
							remove_trait = trait_latent_psionic
							remove_trait = trait_psionic
							change_scoped_species = no

							effect = {
								set_timed_species_flag = {
									flag = assimilation_species_of_species@prev
									days = 30
								}
								set_timed_species_flag = {
									flag = assimilation_species_of_empire@prevprev
									days = 30
								}
							}
						}
					}
					else_if = { # cyborg hive mind
						limit = {
							prev = {
								has_authority = auth_hive_mind
								has_tradition = tr_cybernetics_transubstantiation_synthesis
								NOT = {
									has_civic = civic_hive_devouring_swarm
								}
							}
						}
						modify_species = {
							species = this
							add_trait = trait_cybernetic
							add_trait = trait_hive_mind
							add_traits_at_start_of_list = yes
							remove_trait = trait_self_modified
							remove_trait = trait_latent_psionic
							remove_trait = trait_psionic
							change_scoped_species = no

							effect = {
								set_timed_species_flag = {
									flag = assimilation_species_of_species@prev
									days = 30
								}
								set_timed_species_flag = {
									flag = assimilation_species_of_empire@prevprev
									days = 30
								}
							}
						}
					}
					else_if = {
						limit = {
							prev = {
								NOR = {
									has_ethic = ethic_gestalt_consciousness
									has_tradition = tr_cybernetics_transubstantiation_synthesis
								}
							}
							has_trait = trait_hive_mind
						}
						modify_species = {
							species = this
							remove_trait = trait_hive_mind
							change_scoped_species = no

							effect = {
								set_timed_species_flag = {
									flag = assimilation_species_of_species@prev
									days = 30
								}
								set_timed_species_flag = {
									flag = assimilation_species_of_empire@prevprev
									days = 30
								}
							}
						}
					}
					else_if = { #### Psionic Assimilation ADD OTHER RANDOM OPTIONS TOO
						limit = {
							prev = {
								has_tradition = tr_psionics_psionic_assimilation
							}
						}
						modify_species = {
							species = this
							add_trait = trait_psionic
							add_traits_at_start_of_list = yes
							remove_trait = trait_latent_psionic
							remove_trait = trait_cybernetic
							inline_script = {
								script = traits/remove_all_cybernetic_traits
							}
							effect = {
								set_timed_species_flag = {
									flag = assimilation_species_of_species@prev
									days = 30
								}
								set_timed_species_flag = {
									flag = assimilation_species_of_empire@prevprev
									days = 30
								}
							}
						}
					}
				}
			}

			every_owned_planet = {
				planet_event = { id = action.65 }
			}
		}
	#	set_update_modifiers_batch = end		# |VOP|
	}
}

# Planets in mixed-ownership systems fall to starbase owner
event = {#_|VOP优化|修改trigger
	id = action.85
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		any_country = {
			OR = {#_|VOP优化|从|非原始|改为|普通+堕落|
				is_country_type = default
				is_country_type = fallen_empire
				is_country_type = awakened_fallen_empire
			}
			any_owned_planet = {
				exists = starbase
				starbase = { owner = { NOR = { is_same_value = prevprevprev	is_at_war_with = prevprevprev } } }
			}
		}
	}

	immediate = {
		every_galaxy_planet = {
			limit = {
				exists = owner
				owner = {
					OR = {
						is_country_type = default
						is_country_type = fallen_empire
						is_country_type = awakened_fallen_empire
					}
				}
				exists = starbase
				starbase = {
					exists = owner
					owner = {
						OR = {
							is_country_type = default
							is_country_type = fallen_empire
							is_country_type = awakened_fallen_empire
						}
						NOR = {
							is_same_value = prevprev.owner
							is_at_war_with = prevprev.owner
						}
						NOT = {
							has_active_event = {
								preftl.180 #event to decide fate of pre-ftl civ
							}
						}
					}
				}
			}
			planet_event = { id = action.86 } # planet flips to starbase owner
		}
	}
}

event = {#_|VOP优化|修改trigger
	id = action.90
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		NOT = { any_country = { is_nivirana_battle_country = yes } }	#_|VOP新增|涅槃同步
		any_playable_country = {
			any_owned_planet = {
				is_controlled_by = PREV
				solar_system = { NOT = { exists = starbase } }
			}
		}
	}
	immediate = {
		every_system = {
			limit = {
				NOT = { exists = starbase }
				any_system_colony = {
					exists = owner
					has_ground_combat = no
					owner = {
						OR = {
							is_country_type = default
							is_country_type = fallen_empire
							is_country_type = awakened_fallen_empire
						}
					}
					solar_system = {
						NOR = {
							any_fleet_in_system = {
								exists = owner
								owner = {
									NOT = { is_same_value = prevprevprev.owner }
									OR = {
										is_hostile = prevprevprev.owner
										is_at_war_with = prevprevprev.owner
									}
								}
								is_cloaked = no
							}
							any_fleet_in_system = {
								exists = controller
								controller = {
									NOT = { is_same_value = prevprevprev.owner }
									OR = {
										is_hostile = prevprevprev.owner
										is_at_war_with = prevprevprev.owner
									}
								}
								is_cloaked = no
							}
							any_system_colony = {
								exists = owner
								NOT = { is_same_value = prevprev }
								owner = {
									NOT = { is_same_value = prevprevprev.owner }
									OR = {
										is_country_type = default
										is_country_type = fallen_empire
										is_country_type = awakened_fallen_empire
									}
								}
							}
						}
					}
				}
			}
			random_system_colony = {
				limit = {
					is_colony = yes
					exists = owner
					has_ground_combat = no
					owner = {
						OR = {
							is_country_type = default
							is_country_type = fallen_empire
							is_country_type = awakened_fallen_empire
						}
					}
					solar_system = {
						NOR = {
							any_fleet_in_system = {
								exists = owner
								owner = {
									NOT = { is_same_value = prevprevprev.owner }
									OR = {
										is_hostile = prevprevprev.owner
										is_at_war_with = prevprevprev.owner
									}
								}
								is_cloaked = no
							}
							any_fleet_in_system = {
								exists = controller
								controller = {
									NOT = { is_same_value = prevprevprev.owner }
									OR = {
										is_hostile = prevprevprev.owner
										is_at_war_with = prevprevprev.owner
									}
								}
								is_cloaked = no
							}
							any_system_colony = {
								exists = owner
								owner = {
									NOT = { is_same_value = prevprevprev.owner }
									OR = {
										is_country_type = default
										is_country_type = fallen_empire
										is_country_type = awakened_fallen_empire
									}
								}
							}
						}
					}
				}
				# Fruitful Origin - the outpost is being created for the first time
				if = {
					limit = {
						has_planet_flag = seed_pods_colonization
					}
					planet_event = { id = origin.7400 }
				}
				# else, fire the normal "Outpost Rebuilt!" event
				else = {
					planet_event = { id = action.91 }
				}
			}
		}
	}
}


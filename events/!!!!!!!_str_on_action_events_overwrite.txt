#	|VOP新增/VOP优化|	同步追踪|3.14.159	\events\on_action_events_1.txt		action.85/action.222/action.301/action.300/
namespace = action


# Assimilate Pops on Yearly Pulse

# Planets in mixed-ownership systems fall to starbase owner
event = {#_|VOP优化|修改trigger
	id = action.85
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		any_country = {
			OR = {#_|VOP优化|从|非原始|改为|普通+堕落|
				is_country_type = default
				is_country_type = fallen_empire
				is_country_type = awakened_fallen_empire
			}
			any_owned_planet = {
				exists = starbase
				starbase = { owner = { NOR = { is_same_value = prevprevprev	is_at_war_with = prevprevprev } } }
			}
		}
	}

	immediate = {
		every_galaxy_planet = {
			limit = {
				exists = owner
				owner = {
					OR = {
						is_country_type = default
						is_country_type = fallen_empire
						is_country_type = awakened_fallen_empire
					}
				}
				exists = starbase
				starbase = {
					exists = owner
					owner = {
						OR = {
							is_country_type = default
							is_country_type = fallen_empire
							is_country_type = awakened_fallen_empire
						}
						NOR = {
							is_same_value = prevprev.owner
							is_at_war_with = prevprev.owner
						}
						NOT = {
							has_active_event = {
								preftl.180 #event to decide fate of pre-ftl civ
							}
						}
					}
				}
			}
			planet_event = { id = action.86 } # planet flips to starbase owner
		}
	}
}


planet_event = {#_|VOP新增|添加trigger
	id = action.222
	hide_window = yes

	is_triggered_only = yes

	trigger = {#_|VOP新增|
		exists = owner
		owner = {
			has_origin = origin_doomsday
			is_ai = yes
			any_owned_planet = {
				has_planet_flag = doomed_planet_origin
			}
		}
		NOT = { has_planet_flag = doomed_planet_origin }
	}

	immediate = {
		if = { #save the AI from doomsday if it manages to colonise
			limit = {
				exists = owner
				owner = {
					has_origin = origin_doomsday
					is_ai = yes
					any_owned_planet = {
						has_planet_flag = doomed_planet_origin
					}
				}
				NOT = { has_planet_flag = doomed_planet_origin }
			}
			owner = {
				random_owned_planet = {
					limit = {
						has_planet_flag = doomed_planet_origin
						pop_amount > 300
					}
					while = {
						count = 3
						random_owned_pop_group = {
							limit = {
								OR = {
									prev = { has_modifier = doomsday_5 }
									root = {
										habitability = {
											who = prev.species
											value > 0.3
										}
									}
								}
							}
							resettle_pop_group = {
								POP_GROUP = this
								PLANET = root
								AMOUNT = 100
							}
						}
					}
				}
			}
		}
	}
}

system_event = {#_|VOP新增|添加trigger
	id = action.301
	is_triggered_only = yes
	hide_window = yes
	trigger = {#_|VOP新增|
		any_system_megastructure = {
			exists = owner
			owner = { NOT = { is_same_value = from } }
			OR = {
				is_megastructure_type = gateway_ruined
				is_megastructure_type = gateway_restored
				is_megastructure_type = gateway_final
				is_megastructure_type = hyper_relay_ruined
				is_megastructure_type = hyper_relay_restored
				is_megastructure_type = hyper_relay
			}
		}
	}
	immediate = {
		every_system_megastructure = {
			limit = {
				OR = {
					is_megastructure_type = gateway_ruined
					is_megastructure_type = gateway_restored
					is_megastructure_type = gateway_final
					is_megastructure_type = hyper_relay_ruined
					is_megastructure_type = hyper_relay_restored
					is_megastructure_type = hyper_relay
				}
			}
			set_owner = FROM
		}
	}
}

system_event = {#_|VOP新增|添加trigger
	id = action.300
	is_triggered_only = yes
	hide_window = yes
	trigger = {#_|VOP新增
		any_system_megastructure = {
			exists = owner
			owner = { NOT = { is_same_value = from } }
			OR = {
				is_megastructure_type = gateway_ruined
				is_megastructure_type = gateway_restored
				is_megastructure_type = gateway_final
				is_megastructure_type = hyper_relay_ruined
				is_megastructure_type = hyper_relay_restored
				is_megastructure_type = hyper_relay
			}
		}
	}
	immediate = {
		every_system_megastructure = {
			limit = {
				OR = {
					is_megastructure_type = gateway_ruined
					is_megastructure_type = gateway_restored
					is_megastructure_type = gateway_final
					is_megastructure_type = hyper_relay_ruined
					is_megastructure_type = hyper_relay_restored
					is_megastructure_type = hyper_relay
				}
			}
			set_owner = FROM
		}
	}
}

